{% extends 'mabipint/base.html' %}

{% block title %}Modifier Devis {{ devis.numero }} - MABIPINT{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">

    <!-- En-tête -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900">
            <i class="fas fa-edit text-blue-600 mr-3"></i>Modifier le devis {{ devis.numero }}
        </h1>
        <p class="text-gray-600 mt-2">Modifiez les informations du devis</p>
    </div>

    <form method="post" id="devisForm">
        {% csrf_token %}

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Formulaire principal -->
            <div class="lg:col-span-2 space-y-6">

                <!-- Informations client -->
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4 flex items-center">
                        <i class="fas fa-user text-blue-600 mr-2"></i>Informations du client
                    </h2>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nom du client *</label>
                            {{ form.client_nom }}
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                            {{ form.client_email }}
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Téléphone</label>
                            {{ form.client_telephone }}
                        </div>

                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Adresse</label>
                            {{ form.client_adresse }}
                        </div>
                    </div>
                </div>

                <!-- Lignes du devis -->
                <div class="bg-white rounded-xl shadow-md p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-gray-900 flex items-center">
                            <i class="fas fa-list text-blue-600 mr-2"></i>Lignes du devis
                        </h2>
                        <button type="button" onclick="ajouterLigne()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition">
                            <i class="fas fa-plus mr-2"></i>Ajouter une ligne
                        </button>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="min-w-full" id="lignesTable">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">N°</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Libellé</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Unité</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Qté</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">P.U</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">P.T</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Action</th>
                                </tr>
                            </thead>
                            <tbody id="lignesBody">
                                <!-- Les lignes seront ajoutées ici dynamiquement -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Notes -->
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4 flex items-center">
                        <i class="fas fa-sticky-note text-blue-600 mr-2"></i>Notes et observations
                    </h2>
                    {{ form.notes }}
                </div>

            </div>

            <!-- Résumé et actions -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-xl shadow-md p-6 sticky top-4">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4 flex items-center">
                        <i class="fas fa-calculator text-blue-600 mr-2"></i>Résumé
                    </h2>

                    <div class="space-y-3 mb-6">
                        <div class="flex justify-between items-center pb-2 border-b">
                            <span class="text-gray-600">Total Fourniture:</span>
                            <span class="font-semibold text-lg" id="totalFourniture">0.00 FC</span>
                        </div>

                        <div class="flex justify-between items-center pb-2 border-b">
                            <span class="text-gray-600">M.O (25%):</span>
                            <span class="font-semibold text-lg" id="mainOeuvre">0.00 FC</span>
                        </div>

                        <div class="flex justify-between items-center pt-2 bg-blue-50 p-3 rounded-lg">
                            <span class="text-gray-900 font-semibold">Total Général:</span>
                            <span class="font-bold text-2xl text-blue-600" id="totalGeneral">0.00 FC</span>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Statut</label>
                        {{ form.statut }}
                    </div>

                    <div class="space-y-3">
                        <button type="submit" class="w-full bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition shadow-md hover:shadow-lg font-semibold">
                            <i class="fas fa-save mr-2"></i>Enregistrer les modifications
                        </button>

                        <a href="{% url 'devis_detail' devis.pk %}" class="block w-full text-center bg-gray-200 text-gray-700 px-6 py-3 rounded-lg hover:bg-gray-300 transition">
                            <i class="fas fa-times mr-2"></i>Annuler
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Champ caché pour les données des lignes -->
        <input type="hidden" name="lignes_data" id="lignesData">
    </form>

</div>
{% endblock %}

{% block extra_js %}
<script>
let ligneCounter = 0;
let lignes = {{ lignes_json|safe }};

const unites = [
    {value: 'piece', label: 'Pièce'},
    {value: 'm2', label: 'm²'},
    {value: 'm3', label: 'm³'},
    {value: 'kg', label: 'Kg'},
    {value: 'tonne', label: 'Tonne'},
    {value: 'litre', label: 'Litre'},
    {value: 'metre', label: 'Mètre'},
    {value: 'heure', label: 'Heure'},
    {value: 'jour', label: 'Jour'},
    {value: 'forfait', label: 'Forfait'}
];

// Ajouter des IDs aux lignes existantes
lignes = lignes.map((ligne, index) => ({
    ...ligne,
    id: index + 1
}));
ligneCounter = lignes.length;

function ajouterLigne() {
    ligneCounter++;
    const ligne = {
        id: ligneCounter,
        numero: ligneCounter,
        libelle: '',
        unite: 'piece',
        quantite: 1,
        prix_unitaire: 0
    };

    lignes.push(ligne);
    afficherLignes();
}

function supprimerLigne(id) {
    lignes = lignes.filter(l => l.id !== id);
    afficherLignes();
}

function afficherLignes() {
    const tbody = document.getElementById('lignesBody');
    tbody.innerHTML = '';

    lignes.forEach((ligne, index) => {
        const prixTotal = (parseFloat(ligne.quantite) || 0) * (parseFloat(ligne.prix_unitaire) || 0);

        const tr = document.createElement('tr');
        tr.className = 'border-b hover:bg-gray-50';
        tr.innerHTML = `
            <td class="px-3 py-2">
                <input type="number" value="${ligne.numero}" min="1"
                       class="w-16 px-2 py-1 border rounded text-center"
                       onchange="updateLigne(${ligne.id}, 'numero', this.value)">
            </td>
            <td class="px-3 py-2">
                <input type="text" value="${ligne.libelle}" placeholder="Description"
                       class="w-full px-3 py-1 border rounded"
                       onchange="updateLigne(${ligne.id}, 'libelle', this.value)">
            </td>
            <td class="px-3 py-2">
                <select class="px-2 py-1 border rounded"
                        onchange="updateLigne(${ligne.id}, 'unite', this.value)">
                    ${unites.map(u => `<option value="${u.value}" ${ligne.unite === u.value ? 'selected' : ''}>${u.label}</option>`).join('')}
                </select>
            </td>
            <td class="px-3 py-2">
                <input type="number" value="${ligne.quantite}" min="0" step="0.01"
                       class="w-24 px-2 py-1 border rounded"
                       onchange="updateLigne(${ligne.id}, 'quantite', this.value)">
            </td>
            <td class="px-3 py-2">
                <input type="number" value="${ligne.prix_unitaire}" min="0" step="0.01"
                       class="w-28 px-2 py-1 border rounded"
                       onchange="updateLigne(${ligne.id}, 'prix_unitaire', this.value)">
            </td>
            <td class="px-3 py-2 font-semibold text-gray-900">
                ${prixTotal.toFixed(2)} FC
            </td>
            <td class="px-3 py-2">
                <button type="button" onclick="supprimerLigne(${ligne.id})"
                        class="text-red-600 hover:text-red-800">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        tbody.appendChild(tr);
    });

    calculerTotaux();
}

function updateLigne(id, field, value) {
    const ligne = lignes.find(l => l.id === id);
    if (ligne) {
        ligne[field] = value;
        afficherLignes();
    }
}

function calculerTotaux() {
    let totalFourniture = 0;

    lignes.forEach(ligne => {
        const pt = (parseFloat(ligne.quantite) || 0) * (parseFloat(ligne.prix_unitaire) || 0);
        totalFourniture += pt;
    });

    const mainOeuvre = totalFourniture * 0.25;
    const totalGeneral = totalFourniture + mainOeuvre;

    document.getElementById('totalFourniture').textContent = totalFourniture.toFixed(2) + ' FC';
    document.getElementById('mainOeuvre').textContent = mainOeuvre.toFixed(2) + ' FC';
    document.getElementById('totalGeneral').textContent = totalGeneral.toFixed(2) + ' FC';
}

// Soumettre le formulaire
document.getElementById('devisForm').addEventListener('submit', function(e) {
    // Préparer les données des lignes
    const lignesData = lignes.map(l => ({
        numero: parseInt(l.numero),
        libelle: l.libelle,
        unite: l.unite,
        quantite: parseFloat(l.quantite),
        prix_unitaire: parseFloat(l.prix_unitaire)
    }));

    document.getElementById('lignesData').value = JSON.stringify(lignesData);
});

// Afficher les lignes au chargement
window.addEventListener('load', function() {
    afficherLignes();
});
</script>
{% endblock %}
